name: auto pr-pull

on:
  workflow_run:
    workflows: ["brew test-bot"]
    types: [completed]

jobs:
  pr-pull:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'pull_request' }}
    runs-on: ubuntu-22.04
    permissions:
      actions: read
      checks: read
      contents: write
      issues: read
      pull-requests: write

    steps:
      - name: Resolve PR
        id: resolve-pr
        uses: actions/github-script@v7
        with:
          script: |
            const headBranch = context.payload.workflow_run.head_branch;
            const headSha = context.payload.workflow_run.head_sha;

            // We only auto-publish for automated release branches.
            if (!headBranch || !(headBranch.startsWith('chroma-') || headBranch.startsWith('xin-'))) {
              core.info('Head branch is not from an automated release (chroma-* / xin-*).');
              return;
            }

            // Resolve the PR. Prefer open PR by head branch; fallback to commit association.
            let pr;
            {
              const prs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                head: `${context.repo.owner}:${headBranch}`,
              });
              if (prs.data && prs.data.length > 0) {
                pr = prs.data[0];
              }
            }

            if (!pr && headSha) {
              try {
                const prsByCommit = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  commit_sha: headSha,
                  mediaType: { previews: ['groot'] },
                });
                const open = (prsByCommit.data || []).find(p => p.state === 'open');
                if (open) pr = open;
              } catch (e) {
                core.info(`Failed to resolve PR via commit ${headSha}: ${e}`);
              }
            }

            if (!pr) {
              core.info(`No open PR found for head branch ${headBranch}.`);
              return;
            }

            core.setOutput('pr_number', pr.number.toString());
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('head_repo_fork', pr.head.repo && pr.head.repo.fork ? 'true' : 'false');

      - name: "Guard: only run for non-fork PRs"
        if: steps.resolve-pr.outputs.head_repo_fork == 'true' || steps.resolve-pr.outputs.pr_number == ''
        run: |
          echo "Skip: fork PR or PR not resolved."
          exit 0

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up git
        uses: Homebrew/actions/git-user-config@main

      - name: Pull bottles
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PULL_REQUEST: ${{ steps.resolve-pr.outputs.pr_number }}
        run: brew pr-pull --debug --tap="$GITHUB_REPOSITORY" "$PULL_REQUEST"

      - name: Push commits
        uses: Homebrew/actions/git-try-push@main
        with:
          branch: main

      - name: Delete branch
        if: steps.resolve-pr.outputs.head_repo_fork != 'true' && steps.resolve-pr.outputs.head_ref != ''
        env:
          BRANCH: ${{ steps.resolve-pr.outputs.head_ref }}
        run: git push --delete origin "$BRANCH"
